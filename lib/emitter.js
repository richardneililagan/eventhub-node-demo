'use strict';

var crypto = require('crypto');
var uuid = require('uuid');
var got = require('got');
var assign = require('lodash/assign');

var config = require('./config');

var cache = new WeakMap();

function createToken(url, keyname, keyvalue) {
  var hmac = crypto.createHmac('sha256', keyvalue);

  // :: give this token 24 hours before it expires
  var expiry = ~ ~(+new Date() / 1000) + 60 * 60 * 24;

  hmac.update(`${ encodeURIComponent(url) }\n${ expiry }`);
  var signature = hmac.digest('base64');

  return `SharedAccessSignature sr=${ encodeURIComponent(url) }&sig=${ encodeURIComponent(signature) }&se=${ expiry }&skn=${ keyname }`;
}

class Emitter {
  constructor(opts) {
    var cachebag = assign({}, opts);

    this.name = uuid.v4();
    cachebag.__hubUrl = `https://${ config.namespace }/${ config.eventhubname }/publishers/${ this.name }/messages`;
    cachebag.__sasToken = createToken(cachebag.__hubUrl, config.sak_name, config.sak_value);

    cache.set(this, cachebag);
  }

  emit() {
    var _this = this;

    var cachebag = cache.get(this);
    var record = cachebag.iterator.next().value;

    got(cachebag.__hubUrl, {
      method: 'POST',
      body: record,
      headers: {
        'Authorization': cachebag.__sasToken
      }
    }).then(function (_) {
      console.log(`Event sent from ${ _this.name }`);
    }).catch(function (err) {
      console.log(err);
    });
  }

  start() {
    var _this2 = this;

    var count = 0;
    var timing = setInterval(function (_) {
      _this2.emit();
      if (++count === cache.get(_this2).limit) {
        clearInterval(timing);
      }
    }, cache.get(this).interval);

    return this;
  }
}

module.exports = Emitter;
//# sourceMappingURL=data:application/json;base64,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aUIsT0FBakIiLCJmaWxlIjoiZW1pdHRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG52YXIgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJylcbnZhciB1dWlkID0gcmVxdWlyZSgndXVpZCcpXG52YXIgZ290ID0gcmVxdWlyZSgnZ290JylcbnZhciBhc3NpZ24gPSByZXF1aXJlKCdsb2Rhc2gvYXNzaWduJylcblxudmFyIGNvbmZpZyA9IHJlcXVpcmUoJy4vY29uZmlnJylcblxudmFyIGNhY2hlID0gbmV3IFdlYWtNYXAoKVxuXG5mdW5jdGlvbiBjcmVhdGVUb2tlbiAodXJsLCBrZXluYW1lLCBrZXl2YWx1ZSkge1xuICB2YXIgaG1hYyA9IGNyeXB0by5jcmVhdGVIbWFjKCdzaGEyNTYnLCBrZXl2YWx1ZSlcblxuICAvLyA6OiBnaXZlIHRoaXMgdG9rZW4gMjQgaG91cnMgYmVmb3JlIGl0IGV4cGlyZXNcbiAgdmFyIGV4cGlyeSA9ICh+figrbmV3IERhdGUoKSAvIDEwMDApKSArICg2MCAqIDYwICogMjQpXG5cbiAgaG1hYy51cGRhdGUoYCR7IGVuY29kZVVSSUNvbXBvbmVudCh1cmwpIH1cXG4keyBleHBpcnkgfWApXG4gIHZhciBzaWduYXR1cmUgPSBobWFjLmRpZ2VzdCgnYmFzZTY0JylcblxuICByZXR1cm4gYFNoYXJlZEFjY2Vzc1NpZ25hdHVyZSBzcj0keyBlbmNvZGVVUklDb21wb25lbnQodXJsKSB9JnNpZz0keyBlbmNvZGVVUklDb21wb25lbnQoc2lnbmF0dXJlKSB9JnNlPSR7IGV4cGlyeSB9JnNrbj0keyBrZXluYW1lIH1gXG59XG5cbmNsYXNzIEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cykge1xuICAgIHZhciBjYWNoZWJhZyA9IGFzc2lnbih7fSwgb3B0cylcblxuICAgIHRoaXMubmFtZSA9IHV1aWQudjQoKVxuICAgIGNhY2hlYmFnLl9faHViVXJsID0gYGh0dHBzOi8vJHsgY29uZmlnLm5hbWVzcGFjZSB9LyR7IGNvbmZpZy5ldmVudGh1Ym5hbWUgfS9wdWJsaXNoZXJzLyR7IHRoaXMubmFtZSB9L21lc3NhZ2VzYFxuICAgIGNhY2hlYmFnLl9fc2FzVG9rZW4gPSBjcmVhdGVUb2tlbihjYWNoZWJhZy5fX2h1YlVybCwgY29uZmlnLnNha19uYW1lLCBjb25maWcuc2FrX3ZhbHVlKVxuXG4gICAgY2FjaGUuc2V0KHRoaXMsIGNhY2hlYmFnKVxuICB9XG5cbiAgZW1pdCAoKSB7XG4gICAgdmFyIGNhY2hlYmFnID0gY2FjaGUuZ2V0KHRoaXMpXG4gICAgdmFyIHJlY29yZCA9IGNhY2hlYmFnLml0ZXJhdG9yLm5leHQoKS52YWx1ZVxuXG4gICAgZ290KGNhY2hlYmFnLl9faHViVXJsLCB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIGJvZHk6IHJlY29yZCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBjYWNoZWJhZy5fX3Nhc1Rva2VuXG4gICAgICB9XG4gICAgfSlcbiAgICAgIC50aGVuKF8gPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhgRXZlbnQgc2VudCBmcm9tICR7IHRoaXMubmFtZSB9YClcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKVxuICAgICAgfSlcbiAgfVxuXG4gIHN0YXJ0ICgpIHtcbiAgICB2YXIgY291bnQgPSAwXG4gICAgdmFyIHRpbWluZyA9IHNldEludGVydmFsKF8gPT4ge1xuICAgICAgdGhpcy5lbWl0KClcbiAgICAgIGlmICgrK2NvdW50ID09PSBjYWNoZS5nZXQodGhpcykubGltaXQpIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1pbmcpXG4gICAgICB9XG4gICAgfSwgY2FjaGUuZ2V0KHRoaXMpLmludGVydmFsKVxuXG4gICAgcmV0dXJuIHRoaXNcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEVtaXR0ZXJcbiJdfQ==